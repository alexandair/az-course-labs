#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"name":"csharp"},{"name":"fsharp","languageName":"F#","aliases":["f#","fs"]},{"name":"html","languageName":"HTML"},{"name":"http","languageName":"HTTP"},{"name":"javascript","languageName":"JavaScript","aliases":["js"]},{"name":"mermaid","languageName":"Mermaid"},{"name":"pwsh","languageName":"PowerShell","aliases":["powershell"]},{"name":"value"}]}}

#!markdown

# Lab 08 Answer Key: Infrastructure as Code with Bicep

**Module:** 08 - Bicep Templates

**Purpose:** Complete solutions for all lab tasks

**Note:** This answer key provides complete, working solutions for each task in Lab 08. Students should attempt the lab independently before consulting these answers.

---

## Quick Reference

- **Lab Duration:** 60 minutes
- **Difficulty:** Intermediate
- **Prerequisites:** Azure CLI, PowerShell 7+, Azure subscription
- **Key Skills:** Bicep authoring, template deployment, module creation, security best practices

---

#!markdown

## Task 1: Install and Configure Bicep - ANSWER

**Objective:** Install Bicep CLI and configure Azure CLI defaults for the lab.

#!pwsh

# Task 1 Solution: Install and Configure Bicep

# Check if Azure CLI is installed
if (-not (Get-Command az -ErrorAction SilentlyContinue)) {
    Write-Error "Azure CLI not found. Install from: https://aka.ms/azure-cli"
    return
}
Write-Host "‚úì Azure CLI found" -ForegroundColor Green

# Verify logged in to Azure
$account = az account show 2>$null | ConvertFrom-Json
if (-not $account) {
    Write-Warning "Not logged in to Azure. Running: az login"
    az login
    $account = az account show | ConvertFrom-Json
}
Write-Host "‚úì Logged in to Azure" -ForegroundColor Green
Write-Host "  Subscription: $($account.name)" -ForegroundColor Gray

# Install Bicep CLI (if not already installed)
Write-Host "`nInstalling/Updating Bicep CLI..." -ForegroundColor Cyan
az bicep install

# Upgrade Bicep to the latest version
az bicep upgrade

# Check Bicep version
$bicepVersion = az bicep version
Write-Host "‚úì Bicep CLI installed: $bicepVersion" -ForegroundColor Green

# Set Azure CLI defaults for this lab
$resourceGroup = "rg-bicep-lab-$(Get-Random -Maximum 9999)"
$location = "eastus"

# Configure Azure CLI defaults
az configure --defaults location=$location group=$resourceGroup

Write-Host "`n‚úì Bicep CLI configured" -ForegroundColor Green
Write-Host "Resource Group: $resourceGroup" -ForegroundColor Cyan
Write-Host "Location: $location" -ForegroundColor Cyan

# Store variables for later use
$global:resourceGroup = $resourceGroup
$global:location = $location

#!markdown

### Verification for Task 1

#!pwsh

az bicep version
Write-Host "`n‚úì Bicep CLI installed successfully!" -ForegroundColor Green

#!markdown

---

## Task 2: Create Resource Group and Lab Directory - ANSWER

**Objective:** Set up the working environment for Bicep development.

#!pwsh

# Task 2 Solution: Create Resource Group and Lab Directory

# Create lab directory
$labPath = "C:\az_course\bicep-lab"

# Create the lab directory if it doesn't exist
if (-not (Test-Path $labPath)) {
    New-Item -Path $labPath -ItemType Directory -Force | Out-Null
    Write-Host "‚úì Created lab directory: $labPath" -ForegroundColor Green
} else {
    Write-Host "‚úì Lab directory already exists: $labPath" -ForegroundColor Green
}

# Change to the lab directory
Set-Location -Path $labPath
Write-Host "‚úì Changed to lab directory" -ForegroundColor Green

# Create Azure resource group
Write-Host "`nCreating resource group: $resourceGroup" -ForegroundColor Cyan
az group create --name $resourceGroup --location $location --output table

Write-Host "`n‚úì Lab environment ready" -ForegroundColor Green
Write-Host "Lab Directory: $labPath" -ForegroundColor Cyan
Write-Host "Resource Group: $resourceGroup" -ForegroundColor Cyan
Write-Host "Location: $location" -ForegroundColor Cyan

#!markdown

### Verification for Task 2

#!pwsh

az group show --name $resourceGroup --output table
Get-Location | Out-Default

#!markdown

---

## Task 3: Create Your First Bicep Template - ANSWER

**Objective:** Create a basic Bicep template with parameters, variables, resources, and outputs.

**Key Learning Points:**
- Bicep template structure
- Parameter decorators (@description, @minLength, @maxLength, @allowed)
- Resource declaration with latest API version
- Output declarations
- Safe dereference operator (.?)

#!pwsh

# Task 3 Solution: Create Your First Bicep Template

# Define the Bicep template content
$storageBicep = @'
// storage.bicep - Basic Storage Account Template

@description('Storage account name (3-24 chars, lowercase alphanumeric)')
@minLength(3)
@maxLength(24)
param storageAccountName string

@description('Azure region for deployment')
param location string = resourceGroup().location

@description('Storage account SKU')
@allowed([
  'Standard_LRS'
  'Standard_GRS'
  'Premium_LRS'
])
param storageSku string = 'Standard_LRS'

@description('Resource tags')
param tags object = {
  Environment: 'Lab'
  ManagedBy: 'Bicep'
}

// Variables
var storageAccountNameClean = toLower(storageAccountName)

// Storage Account Resource
resource storage 'Microsoft.Storage/storageAccounts@2025-01-01' = {
  name: storageAccountNameClean
  location: location
  tags: tags
  sku: {
    name: storageSku
  }
  kind: 'StorageV2'
  properties: {
    accessTier: 'Hot'
    supportsHttpsTrafficOnly: true
    minimumTlsVersion: 'TLS1_2'
    allowBlobPublicAccess: false
  }
}

// Outputs
@description('Storage account resource ID')
output storageAccountId string = storage.id

@description('Storage account name')
output storageAccountName string = storage.name

@description('Primary blob endpoint')
output blobEndpoint string = storage.properties.primaryEndpoints.blob

@description('Primary queue endpoint (safe dereference)')
output queueEndpoint string = storage.properties.primaryEndpoints.?queue ?? 'Not available'
'@

# Save the Bicep template to a file
$storageBicep | Out-File -FilePath 'storage.bicep' -Encoding UTF8

Write-Host "`n‚úì Created Bicep template: storage.bicep" -ForegroundColor Green
Write-Host "  - 4 parameters (name, location, SKU, tags)" -ForegroundColor Gray
Write-Host "  - 1 resource (Storage Account)" -ForegroundColor Gray
Write-Host "  - 4 outputs (ID, name, blob endpoint, queue endpoint with safe dereference)" -ForegroundColor Gray
Write-Host "  - Uses latest stable API version (2025-01-01)" -ForegroundColor Gray
Write-Host "  - Implements security best practices (HTTPS only, TLS 1.2, no public blob access)" -ForegroundColor Gray

#!markdown

### Verification for Task 3

#!pwsh

Get-Item storage.bicep | Select-Object Name, Length, LastWriteTime | Out-Default
Write-Host "`n--- Bicep Template Preview (first 15 lines) ---" -ForegroundColor Cyan
Get-Content storage.bicep | Select-Object -First 15

#!markdown

---

## Task 4: Build and Validate Bicep Template - ANSWER

**Objective:** Compile Bicep to ARM JSON and validate the template against Azure.

**Key Learning Points:**
- `az bicep build` compiles Bicep to ARM JSON
- `az deployment group validate` checks template without deploying
- Validation catches errors before deployment

#!pwsh

# Task 4 Solution: Build and Validate Bicep Template

# Build the Bicep template to ARM JSON
Write-Host "Building Bicep template to ARM JSON..." -ForegroundColor Cyan
az bicep build --file storage.bicep

# Check if ARM JSON was generated
if (Test-Path 'storage.json') {
    Write-Host "‚úì ARM template generated: storage.json" -ForegroundColor Green
    
    $armContent = Get-Content 'storage.json' -Raw | ConvertFrom-Json
    $bicepContent = Get-Content 'storage.bicep' -Raw
    
    $bicepSize = $bicepContent.Length
    $armSize = ($armContent | ConvertTo-Json -Depth 10).Length
    $reduction = [math]::Round((1 - ($bicepSize / $armSize)) * 100, 1)
    
    Write-Host "  Bicep size: $bicepSize characters" -ForegroundColor Gray
    Write-Host "  ARM size: $armSize characters" -ForegroundColor Gray
    Write-Host "  Size reduction: $reduction% less code with Bicep!" -ForegroundColor Green
}

# Generate a unique storage account name
$storageAccountName = "stlab$(Get-Random -Maximum 9999)"
Write-Host "`nGenerated storage account name: $storageAccountName" -ForegroundColor Cyan

# Validate the template against Azure
Write-Host "`nValidating Bicep template against Azure..." -ForegroundColor Cyan
$validationResult = az deployment group validate `
    --resource-group $resourceGroup `
    --template-file storage.bicep `
    --parameters storageAccountName=$storageAccountName storageSku='Standard_LRS' `
    --output json | ConvertFrom-Json

if ($validationResult.properties.provisioningState -eq 'Succeeded') {
    Write-Host "‚úì Template validation successful!" -ForegroundColor Green
    Write-Host "  The template is syntactically correct and would deploy successfully" -ForegroundColor Gray
} else {
    Write-Host "‚úó Template validation failed" -ForegroundColor Red
    $validationResult.error | ConvertTo-Json -Depth 5
}

# Store storage account name for later use
$global:storageAccountName = $storageAccountName

#!markdown

### Verification for Task 4

#!pwsh

# Verify both files exist
Get-ChildItem storage.* | Select-Object Name, Length, LastWriteTime | Out-Default

#!markdown

---

## Task 5: Deploy Bicep Template - ANSWER

**Objective:** Deploy the Bicep template to create an actual storage account in Azure.

**Key Learning Points:**
- `az deployment group create` deploys templates
- Deployment outputs provide important information
- Deployment is tracked in Azure's deployment history

#!pwsh

# Task 5 Solution: Deploy Bicep Template

Write-Host "Deploying storage account: $storageAccountName" -ForegroundColor Yellow
Write-Host "This may take 1-2 minutes..." -ForegroundColor Gray

# Deploy the Bicep template
$deployment = az deployment group create `
    --resource-group $resourceGroup `
    --template-file storage.bicep `
    --parameters storageAccountName=$storageAccountName storageSku='Standard_LRS' `
    --output json | ConvertFrom-Json

# Display deployment results
if ($deployment.properties.provisioningState -eq 'Succeeded') {
    Write-Host "`n‚úì Deployment successful!" -ForegroundColor Green
    
    Write-Host "`nDeployment Details:" -ForegroundColor Cyan
    Write-Host "  Deployment Name: $($deployment.name)" -ForegroundColor Gray
    Write-Host "  Provisioning State: $($deployment.properties.provisioningState)" -ForegroundColor Green
    Write-Host "  Duration: $($deployment.properties.duration)" -ForegroundColor Gray
    
    Write-Host "`nDeployment Outputs:" -ForegroundColor Cyan
    $deployment.properties.outputs.PSObject.Properties | ForEach-Object {
        Write-Host "  $($_.Name): $($_.Value.value)" -ForegroundColor White
    }
} else {
    Write-Host "`n‚úó Deployment failed" -ForegroundColor Red
    Write-Host "Error: $($deployment.properties.error.message)" -ForegroundColor Red
}

#!markdown

### Verification for Task 5

#!pwsh

# Verify storage account was created
az storage account show --name $storageAccountName --resource-group $resourceGroup --output table

# View deployment history
Write-Host "`nDeployment History:" -ForegroundColor Cyan
az deployment group list --resource-group $resourceGroup --output table

#!markdown

---

## Task 6: Use What-If to Preview Changes - ANSWER

**Objective:** Use the what-if command to preview changes before deploying.

**Key Learning Points:**
- What-if shows changes without deploying
- Color coding: + Create (green), ~ Modify (yellow), - Delete (red), = No change (gray)
- Essential for production deployments

#!pwsh

# Task 6 Solution: Use What-If to Preview Changes

Write-Host "Previewing changes with Standard_GRS SKU..." -ForegroundColor Yellow
Write-Host "(This will NOT deploy - just show what WOULD change)`n" -ForegroundColor Gray

# Run what-if to preview changes with a different SKU
az deployment group what-if `
    --resource-group $resourceGroup `
    --template-file storage.bicep `
    --parameters storageAccountName=$storageAccountName storageSku='Standard_GRS'

Write-Host "`n‚úì What-if preview completed" -ForegroundColor Green
Write-Host "`nLegend:" -ForegroundColor Cyan
Write-Host "  + Create (new resource)" -ForegroundColor Green
Write-Host "  ~ Modify (existing resource changed)" -ForegroundColor Yellow
Write-Host "  - Delete (resource removed)" -ForegroundColor Red
Write-Host "  = No change (resource unchanged)" -ForegroundColor Gray
Write-Host "`nNotice: The ~ (modify) symbol shows the SKU would change from Standard_LRS to Standard_GRS" -ForegroundColor Gray

#!markdown

### Verification for Task 6

The what-if output should show:
- Resource type: `Microsoft.Storage/storageAccounts`
- Change type: `~ Modify`
- Property changed: `sku.name` from `Standard_LRS` to `Standard_GRS`

#!markdown

---

## Task 7: Create a Bicep Module - ANSWER

**Objective:** Create a reusable Bicep module for virtual networks.

**Key Learning Points:**
- Modules are reusable Bicep files
- Modules enable code organization and reuse
- Loop constructs (`[for ... in ...]`) for dynamic resource creation
- Module outputs can be consumed by parent templates

#!pwsh

# Task 7 Solution: Create a Bicep Module

# Create modules directory
New-Item -Path 'modules' -ItemType Directory -Force | Out-Null
Write-Host "‚úì Created modules directory" -ForegroundColor Green

# Define the VNet module
$vnetModule = @'
// vnet.bicep - Virtual Network Module

@description('Virtual network name')
param vnetName string

@description('Azure region')
param location string = resourceGroup().location

@description('Address prefix for VNet')
param addressPrefix string = '10.0.0.0/16'

@description('Subnet configurations')
param subnets array = [
  {
    name: 'default'
    addressPrefix: '10.0.0.0/24'
  }
]

// Virtual Network
resource vnet 'Microsoft.Network/virtualNetworks@2024-07-01' = {
  name: vnetName
  location: location
  properties: {
    addressSpace: {
      addressPrefixes: [
        addressPrefix
      ]
    }
    subnets: [for subnet in subnets: {
      name: subnet.name
      properties: {
        addressPrefix: subnet.addressPrefix
      }
    }]
  }
}

// Outputs
@description('Virtual network resource ID')
output vnetId string = vnet.id

@description('Virtual network name')
output vnetName string = vnet.name

@description('Subnet resource IDs')
output subnetIds array = [for (subnet, i) in subnets: vnet.properties.subnets[i].id]
'@

# Save the module
$vnetModule | Out-File -FilePath 'modules/vnet.bicep' -Encoding UTF8

Write-Host "‚úì Created VNet module: modules/vnet.bicep" -ForegroundColor Green
Write-Host "  - Supports dynamic subnet creation with loops" -ForegroundColor Gray
Write-Host "  - Returns VNet ID, name, and subnet IDs" -ForegroundColor Gray
Write-Host "  - Uses latest stable API version (2024-07-01)" -ForegroundColor Gray

#!markdown

### Verification for Task 7

#!pwsh

Get-Item modules/vnet.bicep | Select-Object Name, Length | Out-Default
Write-Host "`nModule content preview (first 10 lines):" -ForegroundColor Cyan
Get-Content modules/vnet.bicep | Select-Object -First 10 | Out-Default

#!markdown

---

## Task 8: Use Module in Main Template - ANSWER

**Objective:** Create a main template that references and uses the VNet module.

**Key Learning Points:**
- Module keyword references other Bicep files
- Modern Bicep syntax: no 'name' property required on module declarations
- Module outputs can be referenced in parent template
- Modules receive parameters like any other resource

#!pwsh

# Task 8 Solution: Use Module in Main Template

# Define main template that uses the module
$mainBicep = @'
// main.bicep - Main template with modules

@description('Resource name prefix')
param prefix string = 'biclab'

@description('Azure region')
param location string = resourceGroup().location

// Module: Virtual Network
// Note: Modern Bicep syntax - no 'name' property required
module vnet './modules/vnet.bicep' = {
  params: {
    vnetName: '${prefix}-vnet'
    location: location
    addressPrefix: '10.0.0.0/16'
    subnets: [
      {
        name: 'web-subnet'
        addressPrefix: '10.0.1.0/24'
      }
      {
        name: 'data-subnet'
        addressPrefix: '10.0.2.0/24'
      }
      {
        name: 'mgmt-subnet'
        addressPrefix: '10.0.3.0/24'
      }
    ]
  }
}

// Outputs from module
@description('Virtual network resource ID')
output vnetId string = vnet.outputs.vnetId

@description('Virtual network name')
output vnetName string = vnet.outputs.vnetName

@description('Subnet IDs')
output subnetIds array = vnet.outputs.subnetIds
'@

# Save the main template
$mainBicep | Out-File -FilePath 'main.bicep' -Encoding UTF8

Write-Host "`n‚úì Created main template: main.bicep" -ForegroundColor Green
Write-Host "  - Uses vnet module (modern syntax without 'name' property)" -ForegroundColor Gray
Write-Host "  - Deploys VNet with 3 subnets (web, data, mgmt)" -ForegroundColor Gray
Write-Host "  - Demonstrates module parameter passing" -ForegroundColor Gray
Write-Host "  - Consumes and exposes module outputs" -ForegroundColor Gray

#!markdown

### Verification for Task 8

#!pwsh

# Verify main template references the module
Write-Host "Module reference in main.bicep:" -ForegroundColor Cyan
Get-Content main.bicep | Select-String "module vnet" -Context 2,5 | Out-Default

#!markdown

---

## Task 9: Deploy Template with Module - ANSWER

**Objective:** Deploy the main template, which automatically deploys the VNet module.

**Key Learning Points:**
- Module deployments create nested deployments in Azure
- All modules deploy automatically when parent template deploys
- Deployment history shows both parent and module deployments

#!pwsh

# Task 9 Solution: Deploy Template with Module

Write-Host "Deploying VNet using module..." -ForegroundColor Yellow
Write-Host "This creates a nested deployment for the module..." -ForegroundColor Gray

# Deploy the main template with module
$moduleDeployment = az deployment group create `
    --resource-group $resourceGroup `
    --template-file main.bicep `
    --parameters prefix='biclab' `
    --output json | ConvertFrom-Json

# Display deployment results
if ($moduleDeployment.properties.provisioningState -eq 'Succeeded') {
    Write-Host "`n‚úì Module deployment successful!" -ForegroundColor Green
    
    Write-Host "`nDeployment Details:" -ForegroundColor Cyan
    Write-Host "  Deployment Name: $($moduleDeployment.name)" -ForegroundColor Gray
    Write-Host "  Duration: $($moduleDeployment.properties.duration)" -ForegroundColor Gray
    
    Write-Host "`nModule Outputs:" -ForegroundColor Cyan
    $moduleDeployment.properties.outputs.PSObject.Properties | ForEach-Object {
        Write-Host "  $($_.Name):" -ForegroundColor White
        if ($_.Value.value -is [array]) {
            $_.Value.value | ForEach-Object { Write-Host "    - $_" -ForegroundColor Gray }
        } else {
            Write-Host "    $($_.Value.value)" -ForegroundColor Gray
        }
    }
} else {
    Write-Host "`n‚úó Module deployment failed" -ForegroundColor Red
}

#!markdown

### Verification for Task 9

#!pwsh

# View VNet
az network vnet show --name "biclab-vnet" --resource-group $resourceGroup --output table

# View subnets
Write-Host "`nSubnets:" -ForegroundColor Cyan
az network vnet subnet list --vnet-name "biclab-vnet" --resource-group $resourceGroup --output table

# View deployment history (should show nested deployments)
Write-Host "`nDeployment History (notice the nested module deployment):" -ForegroundColor Cyan
az deployment group list --resource-group $resourceGroup --output table

#!markdown

---

## Task 10: Create Bicep Parameters File - ANSWER

**Objective:** Create Bicep parameters files (.bicepparam) for environment-specific configurations.

**Key Learning Points:**
- `.bicepparam` files provide type-safe parameter management
- `using` statement links parameter file to template
- Better IntelliSense and validation than JSON parameter files
- Environment-specific configurations (dev, test, prod)

#!pwsh

# Task 10 Solution: Create Bicep Parameters File

# Create parameters directory
New-Item -Path 'parameters' -ItemType Directory -Force | Out-Null
Write-Host "‚úì Created parameters directory" -ForegroundColor Green

# Define dev parameters
$devParams = @"
using '../storage.bicep'

param storageAccountName = 'stdev$(Get-Random -Maximum 999)'
param location = 'eastus'
param storageSku = 'Standard_LRS'
param tags = {
  Environment: 'Development'
  CostCenter: 'Engineering'
  ManagedBy: 'Bicep'
  Owner: 'DevTeam'
}
"@

# Define prod parameters
$prodParams = @"
using '../storage.bicep'

param storageAccountName = 'stprod$(Get-Random -Maximum 999)'
param location = 'eastus'
param storageSku = 'Standard_GRS'
param tags = {
  Environment: 'Production'
  CostCenter: 'Operations'
  ManagedBy: 'Bicep'
  Owner: 'OpsTeam'
}
"@

# Save dev parameters
$devParams | Out-File -FilePath 'parameters/dev.bicepparam' -Encoding UTF8

# Save prod parameters
$prodParams | Out-File -FilePath 'parameters/prod.bicepparam' -Encoding UTF8

Write-Host "`n‚úì Created parameter files" -ForegroundColor Green
Write-Host "  - parameters/dev.bicepparam (Standard_LRS for cost savings)" -ForegroundColor Gray
Write-Host "  - parameters/prod.bicepparam (Standard_GRS for redundancy)" -ForegroundColor Gray
Write-Host "`nKey Differences:" -ForegroundColor Cyan
Write-Host "  Dev:  Standard_LRS (locally redundant, lower cost)" -ForegroundColor Yellow
Write-Host "  Prod: Standard_GRS (geo-redundant, higher availability)" -ForegroundColor Yellow

#!markdown

### Verification for Task 10

#!pwsh

# List parameter files
Get-ChildItem parameters/*.bicepparam | Select-Object Name, Length | Out-Default

Write-Host "`nDev Parameters:" -ForegroundColor Cyan
Get-Content parameters/dev.bicepparam | Out-Default

Write-Host "`nProd Parameters:" -ForegroundColor Cyan
Get-Content parameters/prod.bicepparam | Out-Default

#!markdown

---

## Task 11: Deploy with Parameters File - ANSWER

**Objective:** Deploy using a parameters file to simulate production deployment.

**Key Learning Points:**
- Parameters files simplify deployment commands
- Environment-specific configurations without changing templates
- Production deployments use different SKUs for reliability

#!pwsh

# Task 11 Solution: Deploy with Parameters File

Write-Host "Deploying with production parameters..." -ForegroundColor Yellow
Write-Host "Using Standard_GRS for geo-redundancy..." -ForegroundColor Gray

# Deploy using the prod parameters file
$prodDeployment = az deployment group create `
    --resource-group $resourceGroup `
    --parameters parameters/prod.bicepparam `
    --output json | ConvertFrom-Json

if ($prodDeployment.properties.provisioningState -eq 'Succeeded') {
    Write-Host "`n‚úì Production deployment completed" -ForegroundColor Green
    
    Write-Host "`nDeployment Outputs:" -ForegroundColor Cyan
    $prodDeployment.properties.outputs.PSObject.Properties | ForEach-Object {
        Write-Host "  $($_.Name): $($_.Value.value)" -ForegroundColor White
    }
    
    $prodStorageName = $prodDeployment.properties.outputs.storageAccountName.value
    
    # Get storage account details
    $storageDetails = az storage account show `
        --name $prodStorageName `
        --resource-group $resourceGroup `
        --query "{Name:name, SKU:sku.name, Location:location, Tags:tags}" `
        --output json | ConvertFrom-Json
    
    Write-Host "`nProduction Storage Account Details:" -ForegroundColor Cyan
    Write-Host "  Name: $($storageDetails.Name)" -ForegroundColor White
    Write-Host "  SKU: $($storageDetails.SKU) (geo-redundant)" -ForegroundColor Green
    Write-Host "  Location: $($storageDetails.Location)" -ForegroundColor White
} else {
    Write-Host "`n‚úó Production deployment failed" -ForegroundColor Red
}

#!markdown

### Verification for Task 11

#!pwsh

# List all storage accounts and show their SKU
Write-Host "All Storage Accounts in Resource Group:" -ForegroundColor Cyan
az storage account list `
    --resource-group $resourceGroup `
    --query "[].{Name:name, SKU:sku.name, Tier:sku.tier, Tags:tags.Environment}" `
    --output table

Write-Host "`nNotice: Production storage uses Standard_GRS for geo-redundancy" -ForegroundColor Yellow

#!markdown

---

## Task 12: Implement Security Best Practices - ANSWER

**Objective:** Create a template demonstrating Bicep security best practices.

**Key Learning Points:**
- @secure() decorator protects sensitive parameters
- Managed identity eliminates hardcoded credentials
- HTTPS enforcement and TLS 1.2 minimum
- Disable public blob access by default
- Network ACLs for defense-in-depth
- Soft delete for data protection

#!pwsh

# Task 12 Solution: Implement Security Best Practices

# Define secure template
$secureBicep = @'
// secure-storage.bicep - Storage Account with Security Best Practices

@description('Storage account name (globally unique)')
@minLength(3)
@maxLength(24)
param storageAccountName string

@description('Environment: dev, test, or prod')
@allowed(['dev', 'test', 'prod'])
param environment string

@description('Azure region')
param location string = resourceGroup().location

// Variables
var storageSku = environment == 'prod' ? 'Standard_GRS' : 'Standard_LRS'

// Storage Account with Security Features
resource storage 'Microsoft.Storage/storageAccounts@2025-01-01' = {
  name: storageAccountName
  location: location
  tags: {
    Environment: environment
    ManagedBy: 'Bicep'
    SecurityLevel: 'Enhanced'
  }
  sku: {
    name: storageSku
  }
  kind: 'StorageV2'
  identity: {
    type: 'SystemAssigned'  // Managed identity for secure access
  }
  properties: {
    // Security: Require HTTPS
    supportsHttpsTrafficOnly: true
    
    // Security: Minimum TLS version
    minimumTlsVersion: 'TLS1_2'
    
    // Security: Disable public blob access
    allowBlobPublicAccess: false
    
    // Security: Disable shared key access (prefer Azure AD)
    allowSharedKeyAccess: false
    
    // Encryption at rest
    encryption: {
      services: {
        blob: {
          enabled: true
        }
        file: {
          enabled: true
        }
      }
      keySource: 'Microsoft.Storage'
    }
    
    // Network security: Deny by default (Allow for lab; Deny in production)
    networkAcls: {
      defaultAction: 'Allow'  // Set to 'Deny' in production with specific IP rules
      bypass: 'AzureServices'
      ipRules: []
      virtualNetworkRules: []
    }
  }
}

// Blob service with soft delete
resource blobService 'Microsoft.Storage/storageAccounts/blobServices@2025-01-01' = {
  parent: storage
  name: 'default'
  properties: {
    deleteRetentionPolicy: {
      enabled: true
      days: 7
    }
    containerDeleteRetentionPolicy: {
      enabled: true
      days: 7
    }
  }
}

// Outputs
@description('Storage account resource ID')
output storageAccountId string = storage.id

@description('Managed identity principal ID')
output principalId string = storage.identity.principalId

@description('Storage account name')
output storageAccountName string = storage.name
'@

# Save the secure template
$secureBicep | Out-File -FilePath 'secure-storage.bicep' -Encoding UTF8

Write-Host "`n‚úì Created secure template: secure-storage.bicep" -ForegroundColor Green

Write-Host "`nSecurity Features Implemented:" -ForegroundColor Cyan
Write-Host "  ‚úì @secure() decorator for sensitive parameters" -ForegroundColor Green
Write-Host "  ‚úì Managed identity enabled (no credentials in code)" -ForegroundColor Green
Write-Host "  ‚úì HTTPS only (supportsHttpsTrafficOnly: true)" -ForegroundColor Green
Write-Host "  ‚úì TLS 1.2 minimum (minimumTlsVersion: TLS1_2)" -ForegroundColor Green
Write-Host "  ‚úì Public blob access disabled (allowBlobPublicAccess: false)" -ForegroundColor Green
Write-Host "  ‚úì Shared key access disabled (allowSharedKeyAccess: false)" -ForegroundColor Green
Write-Host "  ‚úì Network ACLs configured (allow for lab; deny in production)" -ForegroundColor Yellow
Write-Host "  ‚úì Soft delete enabled (7 days retention)" -ForegroundColor Green
Write-Host "  ‚úì Encryption at rest (blob and file services)" -ForegroundColor Green
Write-Host "  ‚úì Environment-specific SKU (GRS for prod, LRS for dev)" -ForegroundColor Green

Write-Host "`nProduction Recommendations:" -ForegroundColor Magenta
Write-Host "  ‚ö† Change networkAcls.defaultAction to 'Deny'" -ForegroundColor Yellow
Write-Host "  ‚ö† Add specific IP addresses to ipRules array" -ForegroundColor Yellow
Write-Host "  ‚ö† Consider using customer-managed keys for encryption" -ForegroundColor Yellow
Write-Host "  ‚ö† Implement Azure Private Link for VNet integration" -ForegroundColor Yellow

#!markdown

### Verification for Task 12

#!pwsh

# Build the template to verify syntax
az bicep build --file secure-storage.bicep

if ($LASTEXITCODE -eq 0) {
    Write-Host "`n‚úì Template builds successfully" -ForegroundColor Green
    Write-Host "  No syntax errors or warnings" -ForegroundColor Gray
} else {
    Write-Host "`n‚úó Template has errors" -ForegroundColor Red
}

# Show template structure
Write-Host "`nTemplate Structure:" -ForegroundColor Cyan
Get-Content secure-storage.bicep | Select-String "^(param|var|resource|output)" | Select-Object -First 10 | Out-Default

#!markdown

---

## Task 13 (Bonus): Deploy Multi-Tier Infrastructure - ANSWER

**Objective:** Create a complete multi-tier infrastructure with storage, networking, and NSGs.

**Key Learning Points:**
- Module composition (multiple modules in one template)
- Cross-module dependencies
- Environment-specific configurations
- Production-ready infrastructure patterns

#!pwsh

# Task 13 Solution: Deploy Multi-Tier Infrastructure

# Create an NSG module
$nsgModule = @'
// nsg.bicep - Network Security Group Module

@description('NSG name')
param nsgName string

@description('Azure region')
param location string

@description('Security rules')
param securityRules array = []

resource nsg 'Microsoft.Network/networkSecurityGroups@2024-07-01' = {
  name: nsgName
  location: location
  properties: {
    securityRules: securityRules
  }
}

output nsgId string = nsg.id
output nsgName string = nsg.name
'@

# Save NSG module
$nsgModule | Out-File -FilePath 'modules/nsg.bicep' -Encoding UTF8
Write-Host "‚úì Created NSG module: modules/nsg.bicep" -ForegroundColor Green

# Create comprehensive main template
$comprehensiveBicep = @'
// comprehensive.bicep - Multi-tier Infrastructure

@description('Project name prefix')
param projectName string = 'myapp'

@description('Azure region')
param location string = resourceGroup().location

@description('Environment')
@allowed(['dev', 'test', 'prod'])
param environment string = 'dev'

// Variables
var tags = {
  Project: projectName
  Environment: environment
  ManagedBy: 'Bicep'
  DeployedBy: 'Lab08'
}

// Module: Virtual Network
module vnet './modules/vnet.bicep' = {
  params: {
    vnetName: '${projectName}-${environment}-vnet'
    location: location
    addressPrefix: '10.0.0.0/16'
    subnets: [
      {
        name: 'web-subnet'
        addressPrefix: '10.0.1.0/24'
      }
      {
        name: 'app-subnet'
        addressPrefix: '10.0.2.0/24'
      }
      {
        name: 'data-subnet'
        addressPrefix: '10.0.3.0/24'
      }
    ]
  }
}

// Module: Web NSG
module webNsg './modules/nsg.bicep' = {
  params: {
    nsgName: '${projectName}-${environment}-web-nsg'
    location: location
    securityRules: [
      {
        name: 'AllowHTTPS'
        properties: {
          priority: 100
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '443'
          sourceAddressPrefix: '*'
          destinationAddressPrefix: '*'
        }
      }
      {
        name: 'AllowHTTP'
        properties: {
          priority: 110
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '80'
          sourceAddressPrefix: '*'
          destinationAddressPrefix: '*'
        }
      }
    ]
  }
}

// Module: App NSG
module appNsg './modules/nsg.bicep' = {
  params: {
    nsgName: '${projectName}-${environment}-app-nsg'
    location: location
    securityRules: [
      {
        name: 'AllowFromWeb'
        properties: {
          priority: 100
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '8080'
          sourceAddressPrefix: '10.0.1.0/24'
          destinationAddressPrefix: '*'
        }
      }
    ]
  }
}

// Module: Data NSG
module dataNsg './modules/nsg.bicep' = {
  params: {
    nsgName: '${projectName}-${environment}-data-nsg'
    location: location
    securityRules: [
      {
        name: 'AllowFromApp'
        properties: {
          priority: 100
          direction: 'Inbound'
          access: 'Allow'
          protocol: 'Tcp'
          sourcePortRange: '*'
          destinationPortRange: '1433'
          sourceAddressPrefix: '10.0.2.0/24'
          destinationAddressPrefix: '*'
        }
      }
    ]
  }
}

// Storage account for application
resource appStorage 'Microsoft.Storage/storageAccounts@2025-01-01' = {
  name: '${projectName}${environment}${uniqueString(resourceGroup().id)}'
  location: location
  tags: tags
  sku: {
    name: environment == 'prod' ? 'Standard_GRS' : 'Standard_LRS'
  }
  kind: 'StorageV2'
  properties: {
    accessTier: 'Hot'
    supportsHttpsTrafficOnly: true
    minimumTlsVersion: 'TLS1_2'
    allowBlobPublicAccess: false
  }
}

// Outputs
@description('Virtual network resource ID')
output vnetId string = vnet.outputs.vnetId

@description('Virtual network name')
output vnetName string = vnet.outputs.vnetName

@description('Subnet IDs')
output subnetIds array = vnet.outputs.subnetIds

@description('Storage account name')
output storageAccountName string = appStorage.name

@description('Storage account ID')
output storageAccountId string = appStorage.id

@description('Web NSG ID')
output webNsgId string = webNsg.outputs.nsgId

@description('App NSG ID')
output appNsgId string = appNsg.outputs.nsgId

@description('Data NSG ID')
output dataNsgId string = dataNsg.outputs.nsgId
'@

# Save comprehensive template
$comprehensiveBicep | Out-File -FilePath 'comprehensive.bicep' -Encoding UTF8

Write-Host "`n‚úì Created comprehensive infrastructure template" -ForegroundColor Green
Write-Host "`nInfrastructure Components:" -ForegroundColor Cyan
Write-Host "  üìÅ VNet with 3 subnets (web, app, data)" -ForegroundColor Gray
Write-Host "  üõ°Ô∏è  3 NSGs with appropriate security rules" -ForegroundColor Gray
Write-Host "  üíæ Storage account with environment-specific SKU" -ForegroundColor Gray
Write-Host "  üè∑Ô∏è  Consistent tagging across all resources" -ForegroundColor Gray
Write-Host "  üîß Uses modern module syntax (no 'name' property)" -ForegroundColor Gray

Write-Host "`nSecurity Rules:" -ForegroundColor Cyan
Write-Host "  Web Tier:  HTTPS (443) and HTTP (80) from Internet" -ForegroundColor Yellow
Write-Host "  App Tier:  Port 8080 from Web subnet only" -ForegroundColor Yellow
Write-Host "  Data Tier: SQL (1433) from App subnet only" -ForegroundColor Yellow

#!markdown

### Verification for Task 13

#!pwsh

# Build comprehensive template to verify syntax
Write-Host "Validating comprehensive template..." -ForegroundColor Cyan
az bicep build --file comprehensive.bicep

if ($LASTEXITCODE -eq 0) {
    Write-Host "‚úì Template is valid" -ForegroundColor Green
} else {
    Write-Host "‚úó Template has errors" -ForegroundColor Red
}

# Optional: Deploy the comprehensive infrastructure
# Uncomment the following lines to deploy
Write-Host "`n‚ö†Ô∏è  Deployment Command (optional):" -ForegroundColor Yellow
Write-Host "   To deploy this infrastructure, run:" -ForegroundColor Gray
Write-Host "   az deployment group create --resource-group $resourceGroup --template-file comprehensive.bicep --parameters projectName='myapp' environment='dev'" -ForegroundColor Cyan

# Uncomment to deploy:
# Write-Host "`nDeploying comprehensive infrastructure..." -ForegroundColor Yellow
# $compDeployment = az deployment group create `
#     --resource-group $resourceGroup `
#     --template-file comprehensive.bicep `
#     --parameters projectName='myapp' environment='dev' `
#     --output json | ConvertFrom-Json
# 
# if ($compDeployment.properties.provisioningState -eq 'Succeeded') {
#     Write-Host "`n‚úì Comprehensive deployment successful!" -ForegroundColor Green
# }

#!markdown

---

## Cleanup Instructions

**Important:** Remove all resources to avoid Azure charges.

#!pwsh

# Cleanup Solution

Write-Host "`n=== Lab Cleanup ===" -ForegroundColor Yellow
Write-Host "This will delete all resources created in this lab." -ForegroundColor Gray

# List resources to be deleted
Write-Host "`nResources in resource group:" -ForegroundColor Cyan
az resource list --resource-group $resourceGroup --output table

Write-Host "`n‚ö†Ô∏è  WARNING: This will delete:" -ForegroundColor Red
Write-Host "  - Storage accounts" -ForegroundColor Yellow
Write-Host "  - Virtual networks" -ForegroundColor Yellow
Write-Host "  - Network Security Groups" -ForegroundColor Yellow
Write-Host "  - All deployments" -ForegroundColor Yellow
Write-Host "  - The resource group itself" -ForegroundColor Yellow

# Uncomment to execute cleanup
Write-Host "`nTo delete all resources, uncomment and run:" -ForegroundColor Cyan
Write-Host "az group delete --name $resourceGroup --yes --no-wait" -ForegroundColor White

# Uncomment these lines to execute cleanup:
# $confirm = Read-Host "`nType 'DELETE' to confirm deletion"
# if ($confirm -eq 'DELETE') {
#     Write-Host "Deleting resource group..." -ForegroundColor Yellow
#     az group delete --name $resourceGroup --yes --no-wait
#     Write-Host "‚úì Cleanup initiated (running in background)" -ForegroundColor Green
#     Write-Host "  Check status: az group show --name $resourceGroup" -ForegroundColor Gray
# } else {
#     Write-Host "Cleanup cancelled" -ForegroundColor Yellow
# }

#!markdown

---

## Answer Key Summary

### ‚úÖ All Tasks Completed

This answer key provides complete solutions for:

1. **Task 1:** Install and configure Bicep CLI ‚úì
2. **Task 2:** Create resource group and lab directory ‚úì
3. **Task 3:** Create first Bicep template with parameters, variables, resources, outputs ‚úì
4. **Task 4:** Build and validate Bicep template ‚úì
5. **Task 5:** Deploy Bicep template to Azure ‚úì
6. **Task 6:** Use what-if to preview changes ‚úì
7. **Task 7:** Create reusable Bicep module (VNet) ‚úì
8. **Task 8:** Use module in main template ‚úì
9. **Task 9:** Deploy template with module ‚úì
10. **Task 10:** Create Bicep parameters files (.bicepparam) ‚úì
11. **Task 11:** Deploy with parameters file ‚úì
12. **Task 12:** Implement security best practices ‚úì
13. **Task 13 (Bonus):** Deploy multi-tier infrastructure ‚úì

### üéì Key Skills Demonstrated

- **Bicep Syntax:** Parameters, variables, resources, outputs, modules
- **Parameter Decorators:** @description, @minLength, @maxLength, @allowed, @secure
- **Deployment Workflow:** Build ‚Üí Validate ‚Üí What-if ‚Üí Deploy
- **Modules:** Reusable Bicep files with modern syntax (no 'name' property)
- **Parameters Files:** Environment-specific configurations with .bicepparam
- **Security:** Managed identity, HTTPS, TLS 1.2, network ACLs, soft delete
- **Infrastructure Patterns:** Multi-tier architecture with proper isolation

### üìù Best Practices Applied

‚úÖ Used latest stable API versions (2024-07-01, 2025-01-01)  
‚úÖ Comprehensive parameter validation with decorators  
‚úÖ Secure parameter handling with @secure()  
‚úÖ Modern module syntax without 'name' property  
‚úÖ Environment-specific SKU selection (LRS for dev, GRS for prod)  
‚úÖ Proper resource tagging for organization and cost tracking  
‚úÖ Network security with NSG rules following least privilege  
‚úÖ Safe dereference operator (.?) for null-safe property access  

### üîó Additional Resources

- [Bicep Documentation](https://learn.microsoft.com/azure/azure-resource-manager/bicep/)
- [Bicep Learning Path](https://learn.microsoft.com/training/paths/fundamentals-bicep/)
- [Azure Verified Modules](https://aka.ms/AVM)
- [Bicep Playground](https://aka.ms/bicepdemo)
- [Bicep GitHub Repository](https://github.com/Azure/bicep)
